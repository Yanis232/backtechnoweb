<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmation de commande</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="confirmation.css">
</head>

<body>
    <!-- Barre de progression -->
    <header class="progress-header">
        <div class="logo">
            <img src="logo.png" alt="Logo">
        </div>
        <nav class="progress-bar">
            <div class="progress-step completed">
                <i class="bx bx-calendar"></i>
                <p>Sélectionner la date</p>
            </div>
            <div class="progress-step active">
                <i class="bx bx-check-circle"></i>
                <p>Confirmation</p>
            </div>
            <div class="progress-step">
                <i class="bx bx-credit-card"></i>
                <p>Choix du paiement</p>
            </div>
            <div class="progress-step">
                <i class="bx bx-money"></i>
                <p>Paiement</p>
            </div>
            <div class="progress-step">
                <i class="bx bx-envelope"></i>
                <p>Envoi du mail</p>
            </div>
        </nav>
    </header>

    <!-- Contenu principal -->
    <div class="confirmation-container">
        <h1 class="confirmation-title">Confirmation de commande</h1>
        <p class="confirmation-description">
            Vérifiez les détails de votre commande avant de confirmer.
        </p>

        <!-- Détails de la commande -->
        <main class="payment-page">
            <div class="payment-container">
                <div class="order-details">
                    <h2 class="section-title">Votre commande</h2>
                    <div id="cart-summary" class="order-item">
                        <!-- Les détails des articles seront insérés ici -->
                    </div>
                    <div id="order-total" class="order-total">
                        <p><strong>Livraison : Retrait à l'entrepôt (Gratuit)</strong></p>
                        <p><strong>Total du panier: <span id="total-price">0,00</span> €</strong></p>
                </div>
            </div>
        </main>

        <!-- Point de retrait -->

        <div class="pickup-details">
            <h2 class="section-title">Point de retrait</h2>
            <p>Date : <span id="pickup-date"></span></p>
            <p>Créneau horaire : <span id="pickup-slot"></span></p>
        </div>


        <!-- Bouton de confirmation -->
        <button type="button" class="confirm-button" onclick="redirectToPayment()">Confirmer la commande</button>
    </div>

    <!-- Script pour gérer les données -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const pickupDate = localStorage.getItem("pickupDate");
            const pickupSlot = localStorage.getItem("pickupSlot");
    
            if (pickupDate && pickupSlot) {
                // Formater la date au format jour/mois/année
                const formattedDate = formatDate(pickupDate);
                document.getElementById("pickup-date").textContent = formattedDate;
                document.getElementById("pickup-slot").textContent = pickupSlot;
            } else {
                // alert("Aucune information de retrait trouvée. Veuillez recommencer.");
                // window.location.href = "pickup.html"; 
                // window.location.href = "confirmation.html";
            }
        });
    
        // Fonction pour formater la date au format jour/mois/année
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');  // Ajouter un zéro devant si nécessaire
            const month = String(date.getMonth() + 1).padStart(2, '0');  // Les mois commencent à 0, donc on ajoute 1
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        function redirectToPayment() {
            window.location.href = "payement.html";
        }
    </script>

    <!-- Mode sombre -->
    <div id="theme-toggle">
        <button id="theme-toggle-btn" title="Changer le thème">
            <i class="bx bx-sun"></i>
        </button>
    </div>

    <script>
        const themeToggleButton = document.getElementById("theme-toggle-btn");
        const body = document.body;

        // Charger le thème stocké
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
            body.classList.add(savedTheme);
            updateThemeIcon(savedTheme);
        }

        themeToggleButton.addEventListener("click", () => {
            if (body.classList.contains("dark-theme")) {
                body.classList.remove("dark-theme");
                localStorage.setItem("theme", "light-theme");
                updateThemeIcon("light-theme");
            } else {
                body.classList.add("dark-theme");
                localStorage.setItem("theme", "dark-theme");
                updateThemeIcon("dark-theme");
            }
        });

        function updateThemeIcon(theme) {
            const icon = themeToggleButton.querySelector("i");
            if (theme === "dark-theme") {
                icon.classList.remove("bx-sun");
                icon.classList.add("bx-moon");
            } else {
                icon.classList.remove("bx-moon");
                icon.classList.add("bx-sun");
            }
        }
    </script>

    <script>
        function loadOrderSummary() {    // pour charger les données du panier et aff le recap
            const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
            const cartSummary = document.getElementById('cart-summary');
            const totalPriceElement = document.getElementById('total-price');
        
            cartSummary.innerHTML = ''; // maj le contenu 
        
            let totalSum = 0;
        
            if (cartItems.length === 0) {
                cartSummary.innerHTML = '<p>Votre panier est vide.</p>';
                totalPriceElement.textContent = '0,00';
            } else {
                cartItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'order-item';
                    itemDiv.innerHTML = ` 
                        <div class="order-item">
                            <img src="${item.image}" alt="${item.name}" width="100">
                            <div class="order-details">
                                <h3>${item.name}</h3>
                                <p>Prix unitaire : ${item.price.toFixed(2).replace('.', ',')}€</p>
                                <p>Quantité : ${item.quantity}</p>
                                <p>Prix total : ${(item.price * item.quantity).toFixed(2).replace('.', ',')}€</p>
                            </div>
                        </div>
                    `;
                    cartSummary.appendChild(itemDiv);
                    totalSum += item.price * item.quantity;
                });
        
                totalPriceElement.textContent = totalSum.toFixed(2).replace('.', ',');

            }
        }

        
        window.onload = loadOrderSummary;

        
        document.addEventListener("DOMContentLoaded", () => {
            const pickupDetails = JSON.parse(localStorage.getItem("pickupDetails"));
            if (pickupDetails) {
                document.getElementById("pickup-date").textContent = pickupDetails.date;
                document.getElementById("pickup-slot").textContent = pickupDetails.timeSlot;
            } else {
                alert("Aucune information de retrait trouvée. Veuillez recommencer.");
                window.location.href = "pickup.html";
            }
        });
        

        // pour gerer la soumission du formulaire de paiement 
        document.getElementById('submit-order').addEventListener('click', async () => {
            const userId = localStorage.getItem('userId'); // recup de l'userId charger depuis connexion.html
            console.log("User ID récupéré :", userId);
        
            if (!userId) {
                alert("Utilisateur non connecté. Veuillez vous connecter avant de passer une commande.");
                window.location.href = 'connection.html'; 
                return;
            }
        
            const cartItems = JSON.parse(localStorage.getItem('cart')) || []; 
            const totalPrice = cartItems.reduce((total, item) => total + (item.price * item.quantity), 0); 
        
            const orderData = {
                userId: userId,
                cart: cartItems, 
                totalPrice: totalPrice.toFixed(2)
            };
        
            console.log("Données envoyées :", orderData); // envoie à la DB
        
            try {
                const response = await fetch('http://localhost:3000/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erreur réponse serveur :", errorData);
                    alert(`Erreur lors de la commande : ${errorData.message}`);
                } else {
                    alert("Commande passée avec succès !");
                    window.location.href = 'confirmation.html';
                }
            } catch (error) {
                console.error("Erreur lors de la requête :", error);
                alert("Erreur de connexion au serveur.");
            }
        });
    </script>
</body>

</html>
